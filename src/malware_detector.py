"""Detect malware files by SHA1 hash."""

import hashlib
from pathlib import Path
from typing import List, Tuple, Optional


# Known malicious file hashes
MALWARE_HASHES = {
    'bun_environment.js': {
        'd60ec97eea19fffb4809bc35b91033b52490ca11',
        '3d7570d14d34b0ba137d502f042b27b0f37a59fa'
    },
    'setup_bun.js': {
        'd1829b4708126dcc7bea7437c04d1f10eacd4a16'
    }
}

# Files to scan for
MALWARE_FILENAMES = ['bun_environment.js', 'setup_bun.js']


def calculate_sha1(file_path: Path) -> str:
    """Calculate SHA1 hash of a file."""
    sha1_hash = hashlib.sha1()
    
    try:
        with open(file_path, 'rb') as f:
            # Read file in chunks to handle large files
            for chunk in iter(lambda: f.read(4096), b''):
                sha1_hash.update(chunk)
        return sha1_hash.hexdigest()
    except (IOError, OSError):
        return ""


def is_malware_file(file_path: Path) -> bool:
    """Check if a file is one of the known malware filenames."""
    return file_path.name in MALWARE_FILENAMES


def check_file_hash(file_path: Path) -> Tuple[bool, str]:
    """
    Check if a file matches a known malware hash.
    
    Returns:
        (is_malware, sha1_hash)
    """
    if not is_malware_file(file_path):
        return (False, "")
    
    sha1_hash = calculate_sha1(file_path)
    
    if not sha1_hash:
        return (False, "")
    
    filename = file_path.name
    if filename in MALWARE_HASHES:
        if sha1_hash.lower() in {h.lower() for h in MALWARE_HASHES[filename]}:
            return (True, sha1_hash)
    
    return (False, sha1_hash)


def scan_for_malware_files(directory: Path, ignore_patterns: Optional[List[str]] = None) -> List[Tuple[Path, str, bool]]:
    """
    Recursively scan directory for malware files and check their hashes.
    
    Returns:
        List of tuples: (file_path, sha1_hash, is_malware)
    """
    results = []
    
    if ignore_patterns is None:
        ignore_patterns = []
    
    def should_ignore(path: Path) -> bool:
        """Check if path should be ignored."""
        path_str = str(path)
        for pattern in ignore_patterns:
            if pattern in path_str:
                return True
        return False
    
    def scan_recursive(dir_path: Path):
        """Recursively scan directory."""
        try:
            for item in dir_path.iterdir():
                if should_ignore(item):
                    continue
                
                if item.is_file() and is_malware_file(item):
                    is_malware, sha1_hash = check_file_hash(item)
                    results.append((item, sha1_hash, is_malware))
                elif item.is_dir():
                    scan_recursive(item)
        except (PermissionError, OSError):
            # Skip directories we can't access
            pass
    
    scan_recursive(directory)
    return results

